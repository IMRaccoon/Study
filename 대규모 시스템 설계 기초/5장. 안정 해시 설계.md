## 해시 키 재배치(rehash) 문제

N개의 캐시 서버가 있을 때, 부하를 균등하게 나누는 보편적인 방법은 다음 함수와 같다

-   serverIndex = hash(key) % N (N = 서버의 개수)

하지만 위와 같은 방법의 경우, 문제가 발생한다

-   서버가 추가되거나 기존 서버가 삭제되면, 풀의 크기가 변하며, 나머지 연산을 모두 적용시켜야 한다
-   연산이 동작하는 동안 캐시를 통해 데이터를 접근하는 것이 불가능해진다
-   이를 방지하기 위해 안정 해시

## 안정 해시

안정 해시는 해시 테이블 크기가 조정될 때 평균적으로 오직 k/n개의 키만 재배치하는 해시 기술이다

-   k는 키의 개수, n은 슬롯 개수
-   대부분의 전통적 해시 테이블은 슬롯의 수가 바뀌면 거의 대부분 키를 재배치한다

#### 해시 공간과 해시 링

-   SHA-1 해시 함수의 경우, 공간 범위는 0 ~ 2의 160승 - 1 까지 이다
    -   공간 함수는 해시 함수의 출력값 범위를 말한다
-   해시 링은 처음과 끝을 같은 공간으로 보고 만들 수 있는 원형태이다

#### 해시 서버

-   해시 함수를 사용하면 서버 IP나 이름을 해시 링 위에 대응시킬 수 있다

#### 해시 키

-   여기서의 해시 함수는 실제 나머지 연산을 사용하지 않고, 함수를 통해 나온 결과값으로 해시키를 정한다

#### 서버 조회

-   어떤 키가 저장되는 서버는, 해당 키로부터 시계방향으로 링을 탐색해서 만나는 첫번째 서버이다
-   서버도 해시 링 위에 있기 때문에 키가 찾아낼 수 있다

#### 서버 추가

-   서버를 추가하더라도 키 가운데 일부만 재배치하면 된다

#### 서버 제거

-   하나의 서버가 제거되면 키 가운데 일부만 재배치 된다

#### 기본 구현법의 두 가지 문제

안정 해시 알고리즘은 두 가지 문제가 있다

-   서버가 추가되거나 삭제되는 상화의 경우 파티션의 크기를 균등하게 유지하는게 불가능하다
-   키의 균등 분포를 달성하기 어렵다
    이를 위해 가상 노드 또는 복제 기법이 생겼다

#### 가상 노드

-   실제 노드 또는 서버를 가리키는 노드로, 하나의 서버는 링 위의 여러 개의 가상 노드를 가질 수 잇다
    -   임의로 해당 개수를 정할 수 있다
-   각 서버는 하나가 아닌 여러 개의 파티션을 관리하게 된다
-   가상 노드의 개수를 늘리면 키의 분포가 균등해진다
    -   하지만 가상 노드를 늘리면, 가상 노드 데이터를 저장할 공간은 더 필요하게 된다

#### 재배치할 키 결정

-   서버가 추가되거나 제거되면 특정 범위의 키들이 재배치 되어야 한다
    -   삭제된 서버 지점부터 직전 서버 지점까지 포함된 모든 키들을 재배치 시켜야 한다
