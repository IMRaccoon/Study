## 1단계 문제 이해 및 설계 범위 확정

하루에 백만 건 이상의 알림을 처리하는 확장성 높은 시스템을 구축하는게 쉽지 않다
알림 시스템이 어떻게 구현되는지에 대한 깊은 이해가 필요하다

## 2단계 개략적 설계안 제시 및 동의 구하기

#### 알림 유형별 지원 방안

**_iOS 푸시 알림_**
iOS에서 푸시 알림을 보내기 위해서는 세 가지 컴포넌트가 필요하다

-   알림 제공자(provider): 알림 요청을 만들어 애플 푸시 알림 서비스로 보내는 주체이다
    -   필요한 데이터는 다음과 같다
    -   단말 토큰(device token): 알림 요청을 보내는 데 필요한 고유 식별자이다
    -   페이로드(payload): 알림 내용을 담은 JSON 딕셔너리 이다
    -   APNS: 애플리 제공하는 원격 서비스로, iOS 장치로 푸시알림을 보내는 역할을 담당한다
    -   iOS 단말: 푸시 알림을 수신하는 사용자 단말이다

**_안드로이드 푸시 알림_**
APNS 대신 FCM(Firebase Cloud Messaging)을 사용하는 것만 다르다

**_SMS 메시지_**
SMS 메시지를 보낼때는 보통 트윌리오, 넥스모 같은 제 3 사업자의 서비스를 만이 이용한다
대부분 상용 서비스라서 이용요금을 내야 한다

**_이메일_**
상용 이메일 서비스로 센드그리드, 메일침프 등이 있다
전송 성공률도 높고, 데이터 분석 서비스도 제공한다

#### 연락처 정보 수집 절차

알림을 보내기 위해 필요한 정보를 받기 위해, 우리 앱을 설치하거나 계청을 등록하면 API 서브는 사용자의 정보를 수집해 DB에 저장한다

#### 알림 전송 및 수신 절차

**_개략적 설계안 (초안)_**

-   1부터 N까지의 서비스
    -   서비스 각각은 마이크로 서비스이거나 크론집, 또는 분산 시스템 컴포넌트일 수 있다
-   알림 시스템
    -   알림 전송, 수신 처리의 핵심이다
    -   1개의 서버만 사용하는 시스템이라 가정하면, 모든 서비스에 알림 전송을 위한 API를 제공해야 하고
    -   제 3자 서비스에 전달할 알림 페이로드를 만들어 낼 수 있어야 한다
-   제3자 서비스
    -   사용자에게 알림을 시렞로 전달하는 역할을 한다
    -   확장성을 유의해야 하는데, 쉽게 새로운 서비스를 통합하거나 기존 서비스를 제거할 수 있어야 한다
    -   또하나 고려해야 하는 것은, 어떤 서비스는 다른 시장에서 사용할 수 없을 수도 있다는 것이다
-   iOS, 안드로이드, SMS, 이메일 단말
    -   사용자는 단말에서 알림을 수신한다

초안에서의 몇 가지 문제가 있다

-   SPOF(Single-Point-Of-Failure)
    -   알림 서비스에 서버가 하나 밖에 없다는 것은, 서버에 장애가 생기면 전체 서비스의 장애로 이어진다는 뜻이다
-   규모 확장성
    -   한 대 서비스로 푸시 알림에 관련한 모든 것을 처리하므로, 중요 컴포넌트의 규모를 개별적으로 늘릴 방법이 없다
-   성능 병목
    -   알림을 처리하고 보내는 것은 자원을 많이 필요로 하는 적업일 수 있다
    -   HTML 페이지를 만들고 제3자 서비스의 응답을 기다리는 일은 시간이 많이 걸릴 가능성이 있는 작업이다
    -   모든 것을 한 서버로 처리하면 사용자 트래픽이 많이 몰리는 시간에는 시스템이 과부하 상태에 빠질 수 있다

**_개략적 설계안 (개선된 버전)_**
개선 방향

-   데이터베이스와 캐시를 알림 시스템의 주 서버에서 분리한다
-   알림 서버를 증설하고 자동으로 수평적 규모 확장이 이루어질 수 있도록 한다
-   메시지 큐를 이용해 시스템 컴포넌트 사이의 강한 결합을 끊는다

-   알림 서버는 다음과 같은 기능을 제공한다
    -   알림 전송 API: 스팸 방지를 위해 보통 사내 서비스 또는 인증된 클라이언트만 이용 가능하다
    -   알림 검증: 이메일 주소, 전화번호 등에 대한 기본적 검증을 수행한다
    -   데이터 베이스 또는 캐시 질의: 알림에 포함시킬 데이터를 가져오는 기능이다
    -   알림 전송: 알림 데이터를 메시지 큐에 넣으며, 여러 메시지 큐를 사용하여 알림을 병렬적으로 처리할 수 있다
-   캐시: 사용자 정보, 단말 정보, 알림 템플릿 등을 캐시한다
-   데이터베이스: 사용자, 알림, 설정 등 다양한 정보를 저장한다
-   메시지 큐
    -   시스템 컴포넌트 간 의존성을 제거하기 위해 사용한다
    -   다량의 알림이 전송되어야 하는 경우를 대비한 버퍼 역할도 한다
-   작업 서버: 메시지 큐에서 전송할 알림을 꺼내서 제 3자 서비스로 전달하는 역할을 담당하는 서버이다
-   제 3자 서비스
-   iOS, 안드로이드, SMS, 이메일 단말

알림을 전송하는 순서

1. API를 호출하여 알림 서버로 알림을 보낸다
2. 알림 서버는 사용자 정보, 단말 토큰, 알림 설정 같은 메타데이터를 캐시나 데이터베이스에서 가져온다
3. 알림 서버는 전송할 알림에 맞는 이벤트를 만들어 큐에 넣는다
4. 작업 서버는 메시지 큐에서 알림 이벤트를 꺼낸다
5. 작업 서버는 알림을 제 3자 서비스로 보낸다
6. 제 3자 서비스는 사용자 단말로 알림을 전송한다

## 3단계 상세 설계

#### 안정성

**_데이터 손실 방지_**
알림이 지연되거나 순서가 틀려도 되지만, 사라지면 곤란하다
따라서 데이터를 데이터베이스에 보관하고 재시도 메커니즘을 구현해야 한다
알림 로그 데이터베이스를 유지하는 것이 방법이다

**_알림 중복 전송 방지_**
같은 알림이 반복되는 것을 완전히 막는 것은 가능하지 않다
대부분은 한번만 전송되겠지만, 분산 시스템의 특성상 알림이 중복되어 전송되기도 할 것이다
빈도를 줄이려면 중복을 탐지하는 메커니즘을 도입하고, 오류를 신중하게 처리해야 한다
간단한 중복 방지 로직의 사례는, 이벤트 ID를 검사하고 중복된 이벤트라면 버리고, 아니라면 알림을 발송한다

#### 추가로 필요한 컴포넌트 및 고려사항

**_알림 템플릿_**
알림 메시지의 모든 부분을 처음부터 다시 만들 필요 없도록 해주며, 인자나 스타일, 추적 링크를 조정하기만 하면 알람을 만들어 낸다

**_알림 설정_**
사용자가 알림 설정을 상세히 조정할 수 있도록 한다
알림 설정 테이블에 해당 정보가 저장되며, 사용자가 알림을 켜두었는지 확인해야 한다

**_전송률 제한_**
사용자가 받을 수 있는 알림의 빈도를 제한할 수 있다
알림을 너무 많이 보내면, 사용자가 알림 기능을 아예 꺼버릴 수 있다

**_재시도 방법_**
제 3자 서비스가 알림 전송에 실패하면, 재시도 전용 큐에 넣는다
같은 문제가 계속해서 발생하면 개발자에게 통지한다

**_푸시 알림과 보안_**
인증되었거나, 승인된 클라이언트만 해당 API를 사용하여 알림을 보낼수 있다

**_큐 모니터링_**
중요한 메트릭 하나는 큐에 쌓인 알림의 개수로, 수가 너무 크면 적업 서버들이 이벤트를 빠르게 처리하고 있지 못하다는 뜻이다
이런 경우는 작업 서버를 증설하는게 바람직하다

**_이벤트 추적_**
알림 확인율, 클릭율, 실제 앱 사용으로 이어지는 비율 같은 메트릭은 사용자를 이해하는데 중요하다
보통 이벤트 추적 기능도 제공하며, 데이터 분석 서비스와도 통합한다

#### 수정된 설계안

-   알림 서버에 인증과 전송률 제한 기능이 추가되었다
-   전송 실패에 대응하기 위핸 재시도 기능이 추가되었고, 전송에 실패한 알림은 다시 큐에 넣고 지정된 횟수만큼 재시도 한다
-   전송 템플릿을 사용하여 알림 생성 과정을 단순화하고 알림 내용의 일관성을 유지한다
-   몬니터링과 추적 시스템을 추가하여 시스템 상태를 확인하고 추후 시스템을 개선하기 쉽도록 하였다

## 4단계 마무리

개략적 설계안과 더불어 각 컴포넌트의 구현 방법과 최적화 기법에 대해 심도 있게 보았다

-   안정성(reliability): 메시지 전송 실패율을 낮추기 위해 안정적인 재시도 메커니즘을 도입하였다
-   보안(security): 인증된 클라이언트만이 알림을 보낼 수 있도록 appKey, appSecret 등의 메커니즘을 이용하였다
-   이벤트 추적 및 모니터링: 알림이 만들어진 후 성공적으로 전송되기까지의 과정을 추적하고 시스템 상태를 모니터링하기 위해 알림 전송의 각 단계마다 이벤트를 추적하고 모니터링할 수 있는 시스템을 통합하였다
-   사용자 설정: 사용자가 알림 수신 설정을 조정할 수 있도록 하였다. 알림을 보내기전 해당 설정을 확인하도록 시스템 설계를 변경하였다
-   전송률 제한: 사용자에게 알림을 보내는 빈도를 제한할 수 있도록 하였다
